# Система иерархических фильтров

## Обзор

Система полностью перестроена для работы с иерархической структурой фильтров согласно требованиям пользователя. Новая система позволяет создавать публикации с точной настройкой целевой аудитории через многоуровневые фильтры.

## Архитектура

### Структура фильтров

```
Тип учреждения (Колледж/Университет/Школа)
├── Общие фильтры
├── Города (Новосибирск, СПб, Москва, Екатеринбург, Краснодар, Ростов-на-Дону)
└── Учебная информация
    ├── Программы (Программирование, Дизайн, AI, etc.)
    ├── Курсы (1-4 курс)
    ├── Формы обучения (Очная, Заочная, Дистанционная, Смешанная)
    └── Города для форм обучения
```

### Модели базы данных

- **FilterTree** - корневое дерево фильтров
- **FilterInstitutionType** - типы учебных заведений
- **FilterGeneral** - общие категории фильтров
- **FilterCity** - города
- **FilterStudyProgram** - учебные программы
- **FilterCourse** - курсы обучения
- **FilterEducationForm** - формы обучения
- **FilterCityInstance** - города для конкретных форм
- **FilterGroup** - группы студентов
- **ArticleFilter** - связь статей с фильтрами

## Установка и настройка

### 1. Применение миграции

```bash
# В директории проекта
flask db upgrade
```

### 2. Инициализация структуры фильтров

```bash
# Запуск скрипта инициализации
python init_filters.py
```

Скрипт автоматически создаст:
- Дерево фильтров
- Типы учреждений (Колледж, Университет, Школа)
- Полную структуру для колледжа с программами, курсами и формами обучения
- Города для всех комбинаций

### 3. Проверка установки

```bash
# Проверка API
curl http://localhost:5000/api/filters/tree
```

## Использование

### Создание публикации с фильтрами

1. **Выбор типа учреждения** - Колледж/Университет/Школа
2. **Выбор города** - доступны только города для выбранного типа
3. **Выбор программы** - доступны программы для выбранного типа
4. **Выбор курса** - доступны курсы для выбранной программы
5. **Выбор формы обучения** - доступны формы для выбранного курса

### API Endpoints

#### Получение дерева фильтров
```http
GET /api/filters/tree
```

#### Создание дерева фильтров
```http
POST /api/filters/tree
{
  "name": "Название дерева",
  "description": "Описание"
}
```

#### Создание структуры фильтров
```http
POST /api/filters/tree/{id}/structure
{
  "structure": {
    "college": { /* структура колледжа */ },
    "university": { /* структура университета */ },
    "school": { /* структура школы */ }
  }
}
```

#### Получение отфильтрованных статей
```http
GET /api/filters/articles?institution_type=college&city=msk&program=programming&course=1 course&form=full_time
```

#### Назначение фильтров для статьи
```http
POST /api/filters/articles/{id}/filters
{
  "institution_type": "college",
  "city": "msk",
  "program": "programming",
  "course": "1 course",
  "form": "full_time",
  "filter_tree_id": 1,
  "filter_group_ids": [1, 2, 3]
}
```

## Фронтенд компоненты

### PostEditor
- Полностью переработан для работы с новой системой фильтров
- Интерактивные фильтры с зависимостями
- Автоматический сброс зависимых фильтров при изменении родительских

### FilteredPosts
- Новый компонент для просмотра постов с фильтрацией
- Динамическое обновление URL с параметрами фильтров
- Отображение результатов в реальном времени

## Преимущества новой системы

1. **Точность таргетинга** - публикации точно попадают к целевой аудитории
2. **Гибкость** - возможность создания постов для любых комбинаций фильтров
3. **Масштабируемость** - легко добавлять новые типы учреждений, программы, города
4. **Производительность** - использование JSON индексов PostgreSQL для быстрого поиска
5. **Обратная совместимость** - сохранены legacy поля для существующих постов

## Миграция существующих данных

### Автоматическая миграция
Система автоматически обрабатывает существующие посты через legacy поля.

### Ручная миграция
Для существующих постов можно создать фильтры через API:

```bash
# Пример миграции поста для колледжа в Москве
curl -X POST http://localhost:5000/api/filters/articles/1/filters \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "institution_type": "college",
    "city": "msk",
    "filter_tree_id": 1
  }'
```

## Мониторинг и отладка

### Логи
Все операции с фильтрами логируются в стандартные логи Flask.

### Проверка состояния
```bash
# Проверка структуры фильтров
curl http://localhost:5000/api/filters/tree | jq

# Проверка статей с фильтрами
curl "http://localhost:5000/api/filters/articles?institution_type=college" | jq
```

### Очистка данных
```bash
# Удаление всех фильтров (осторожно!)
flask shell
>>> from app.models import *
>>> db.session.query(FilterTree).delete()
>>> db.session.commit()
```

## Производительность

### Индексы
Созданы индексы для всех ключевых полей:
- `is_active` для всех таблиц фильтров
- `filter_tree_id` для статей
- JSON индексы для `filter_path`

### Оптимизация запросов
- Использование JOIN вместо подзапросов
- Кэширование дерева фильтров на фронтенде
- Ленивая загрузка зависимых фильтров

## Безопасность

- Все операции создания/изменения требуют аутентификации
- Проверка прав доступа для административных операций
- Валидация входных данных на всех уровнях

## Поддержка и развитие

### Добавление новых фильтров
1. Обновить модели в `app/models.py`
2. Создать миграцию
3. Обновить API endpoints
4. Обновить фронтенд компоненты

### Расширение структуры
Система легко расширяется для добавления:
- Новых типов учреждений
- Дополнительных уровней фильтрации
- Кастомных меток и тегов

## Troubleshooting

### Частые проблемы

1. **Фильтры не загружаются**
   - Проверить миграцию БД
   - Запустить `init_filters.py`
   - Проверить логи API

2. **Зависимые фильтры не обновляются**
   - Проверить логику в `handleFilterChange`
   - Убедиться в правильности зависимостей

3. **Статьи не находятся**
   - Проверить `filter_path` в базе данных
   - Убедиться в правильности JSON структуры

### Отладка
```bash
# Проверка структуры БД
flask shell
>>> from app.models import *
>>> FilterTree.query.all()
>>> FilterInstitutionType.query.all()
```

## Заключение

Новая система фильтров предоставляет мощный и гибкий инструмент для точного таргетинга публикаций. Система полностью соответствует требованиям пользователя и готова к использованию в продакшене.
